<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>EV Central - Panel de Monitorizaci√≥n</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f5f5f5; color: #333; text-align: center; }
    h1 { color: #007bff; }
    table { margin: 20px auto; border-collapse: collapse; width: 85%; }
    th, td { border: 1px solid #ccc; padding: 10px; }
    th { background: #eee; }
    .estado { font-weight: bold; color: white; border-radius: 4px; padding: 5px 10px; }
    .ACTIVADO { background: #28a745; }
    .SUMINISTRANDO { background: #28a745; }
    .PARADO { background: orange; }
    .DESCONECTADO { background: gray; }
    .AVERIA { background: red; }
    button { margin: 2px; padding: 5px 8px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
    button.stop { background: orange; color: white; }
    button.resume { background: #28a745; color: white; }
    button.global { margin: 5px; padding: 8px 12px; }
  </style>
</head>
<body>
  <h1>‚ö° EV Central - Panel de Monitorizaci√≥n ‚ö°</h1>

  <div style="margin-bottom: 15px;">
    <button class="global stop" onclick="sendCommand('STOP', 'ALL')">üõë STOP ALL</button>
    <button class="global resume" onclick="sendCommand('RESUME', 'ALL')">‚ñ∂Ô∏è RESUME ALL</button>
  </div>

  <!-- Tabla principal CPs -->
  <table id="cpTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>Ubicaci√≥n</th>
        <th>Precio (‚Ç¨/kWh)</th>
        <th>Estado</th>
        <th>kWh total</th>
        <th>‚Ç¨ total</th>
        <th>Driver</th>
        <th>√öltima actualizaci√≥n</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Suministros activos (solo RUNNING desde BD) -->
  <h2>Suministros activos</h2>
  <table id="sessionsTable">
    <thead>
      <tr>
        <th>Inicio (fecha/hora)</th>
        <th>Driver</th>
        <th>CP</th>
        <th>Session ID</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>√öltimos 5 mensajes</h2>
  <table id="messagesTable">
    <thead>
      <tr>
        <th>Fecha/Hora</th>
        <th>Tipo</th>
        <th>Detalle</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="centralState" style="margin-top: 12px; font-weight: bold;">
    Estado de CENTRAL: <span id="centralStateValue">‚Äî</span>
  </div>

  <script>
    // --- Referencias DOM ---
    const tableBody = document.querySelector("#cpTable tbody");
    const sessionsBody = document.querySelector("#sessionsTable tbody");
    const messagesBody = document.querySelector("#messagesTable tbody");
    const centralStateValue = document.getElementById("centralStateValue");

    // --- Helpers CPs ---
    function normalize(cp) {
      return {
        id: cp.id || cp.cp_id,
        location: cp.location ?? "Desconocida",
        price_eur_kwh: Number(cp.price_eur_kwh ?? 0.3),
        status: cp.status || "DESCONECTADO",
        kwh_total: cp.kwh_total ?? null,
        eur_total: cp.eur_total ?? null,
        driver_id: cp.driver_id ?? null
      };
    }
    function fmt(n, digits = 3) {
      return (n === null || n === undefined) ? "‚Äî" : Number(n).toFixed(digits);
    }
    const has = (obj, k) => Object.prototype.hasOwnProperty.call(obj, k);

    function updateRow(raw) {
      const cp = normalize(raw);
      let row = document.getElementById(cp.id);
      const now = new Date().toLocaleTimeString();

      if (!row) {
        row = document.createElement("tr");
        row.id = cp.id;
        row.innerHTML = `
          <td>${cp.id}</td>
          <td>${cp.location}</td>
          <td>${cp.price_eur_kwh.toFixed(2)}</td>
          <td class="estado ${cp.status}">${cp.status}</td>
          <td>${fmt(cp.kwh_total, 3)}</td>
          <td>${fmt(cp.eur_total, 2)}</td>
          <td>${cp.driver_id ?? "‚Äî"}</td>
          <td>${now}</td>
          <td>
            <button class="stop" onclick="sendCommand('STOP', '${cp.id}')">STOP</button>
            <button class="resume" onclick="sendCommand('RESUME', '${cp.id}')">RESUME</button>
          </td>
        `;
        tableBody.appendChild(row);
        return;
      }

      if (has(raw, "location")) row.children[1].textContent = raw.location ?? row.children[1].textContent;
      if (has(raw, "price_eur_kwh")) row.children[2].textContent = Number(raw.price_eur_kwh).toFixed(2);

      if (has(raw, "status")) {
        row.children[3].textContent = cp.status;
        row.children[3].className = "estado " + cp.status;
        if (raw.status !== "SUMINISTRANDO") {
          row.children[4].textContent = "‚Äî";
          row.children[5].textContent = "‚Äî";
          row.children[6].textContent = "‚Äî";
        }
      }
      if (has(raw, "kwh_total")) row.children[4].textContent = fmt(raw.kwh_total, 3);
      if (has(raw, "eur_total")) row.children[5].textContent = fmt(raw.eur_total, 2);
      if (has(raw, "driver_id")) row.children[6].textContent = raw.driver_id ?? "‚Äî";

      if (["location","price_eur_kwh","status","kwh_total","eur_total","driver_id"].some(k => has(raw, k))) {
        row.children[7].textContent = now;
      }
    }

    // --- Helpers sesiones RUNNING (BD) ---
    function rowIdForSession(id) { return `sess-${id}`; }

    function addRunningSession(s) {
      const rid = rowIdForSession(s.session_id);
      if (document.getElementById(rid)) return;
      const tr = document.createElement("tr");
      tr.id = rid;
      tr.innerHTML = `
        <td>${s.ts ?? ""}</td>
        <td>${s.driver_id ?? ""}</td>
        <td>${s.cp_id ?? ""}</td>
        <td>${s.session_id}</td>
      `;
      sessionsBody.prepend(tr);
      while (sessionsBody.children.length > 200) sessionsBody.removeChild(sessionsBody.lastChild);
    }

    function removeSessionRow(session_id) {
      const el = document.getElementById(rowIdForSession(session_id));
      if (el) el.remove();
    }

    function renderRunningSessions(list) {
      sessionsBody.innerHTML = "";
      (list || []).filter(s => s.status === "RUNNING").forEach(addRunningSession);
    }

    // --- Carga inicial ---
    async function loadCPs() {
      const res = await fetch("/cp");
      const data = await res.json();
      data.forEach(updateRow);
    }

    async function loadActiveSessions() {
      try {
        const res = await fetch("/sessions/active"); // ‚Üê BD: solo RUNNING
        const data = await res.json();
        renderRunningSessions(data);
      } catch (e) {
        console.warn("No se pudo cargar /sessions/active:", e);
      }
    }

    async function loadCentralSummary() {
      try {
        const res = await fetch("/central/summary");
        const data = await res.json();
        centralStateValue.textContent = data.status || "‚Äî";
        // OJO: ya no usamos data.sessions aqu√≠ para la tabla de activos,
        // se rellena con /sessions/active (BD). S√≠ usamos los mensajes:
        (data.messages || []).reverse().forEach(prependMessageRow);
      } catch (e) {
        console.warn("No se pudo cargar /central/summary:", e);
      }
    }

    // --- Mensajes buffer ---
    function prependMessageRow(m) {
      const ts = m.ts || new Date().toLocaleString();
      const msgType = m.msg_type || m.type || "MSG";
      const detail = JSON.stringify(m.detail ?? m);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${ts}</td>
        <td>${msgType}</td>
        <td style="font-family: monospace;">${detail}</td>
      `;
      messagesBody.prepend(tr);
      while (messagesBody.children.length > 5) messagesBody.removeChild(messagesBody.lastChild);
    }

    // --- Comandos ---
    async function sendCommand(action, cpId) {
      try {
        const res = await fetch('/command', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action, cp_id: cpId })
        });
        const data = await res.json();
        console.log('Command sent:', data);
      } catch (err) {
        console.error('Error sending command:', err);
      }
    }

    // --- WebSocket (live) ---
    function connectWebSocket() {
      const ws = new WebSocket(`ws://${window.location.host}/ws`);
      ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);

        if (msg.type === "central.msg") { prependMessageRow(msg); return; }

        // Actualizaciones CP
        if ((msg.id || msg.cp_id) && msg.status) { updateRow(msg); return; }

        // Telemetr√≠a
        if (msg.type === "telemetry") {
          updateRow({
            cp_id: msg.cp_id,
            status: "SUMINISTRANDO",
            kwh_total: msg.kwh_total,
            eur_total: msg.eur_total,
            driver_id: msg.driver_id
          });
          return;
        }

        // Sesi√≥n empieza (la a√±adimos a la tabla de activos)
        if (msg.type === "session.started") { addRunningSession(msg); return; }

        // Sesi√≥n termina (la quitamos de la tabla de activos)
        if (msg.type === "session.ended") { removeSessionRow(msg.session_id); return; }

        if (msg.type === "central.state") { centralStateValue.textContent = msg.status; return; }
      };
      ws.onopen = () => console.log("Conectado al panel WebSocket");
      ws.onclose = () => console.log("Desconectado del panel WebSocket");
    }

    // Arranque
    loadCPs();
    loadActiveSessions();   // ‚Üê inicial desde BD
    loadCentralSummary();   // ‚Üê estado y √∫ltimos mensajes
    connectWebSocket();
    
    setInterval(() => {
    loadCPs();           
    loadActiveSessions(); 
    // loadCentralSummary(); para refrescar ultimos mensajes 
  }, 3000);
  </script>
</body>
</html>
